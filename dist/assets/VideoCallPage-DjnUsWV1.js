import{j as o,f as D,u as I,r as s,c as P,l as z}from"./index-merJpfdn.js";const M={position:"absolute",top:"1rem",right:"1rem",width:"300px",height:"calc(100% - 2rem)",backgroundColor:"#fff",border:"1px solid #e2e8f0",borderRadius:"0.75rem",boxShadow:"0 10px 15px -3px rgba(0,0,0,0.1)",display:"flex",flexDirection:"column",transition:"transform 0.3s ease-in-out",zIndex:10},B=({content:a,onContentChange:u,isOpen:d})=>{const f={...M,transform:d?"translateX(0)":"translateX(calc(100% + 2rem))"};return o.jsxs("div",{style:f,children:[o.jsx("h3",{style:{padding:"1rem",fontWeight:600,borderBottom:"1px solid #e2e8f0"},children:"Shared Notes"}),o.jsx("textarea",{value:a,onChange:c=>u(c.target.value),placeholder:"Type your shared notes here...",style:{flex:1,width:"100%",border:"none",padding:"1rem",fontSize:"0.9rem",lineHeight:1.6,resize:"none",outline:"none",backgroundColor:"transparent",borderBottomLeftRadius:"0.75rem",borderBottomRightRadius:"0.75rem"}})]})},H=({startTime:a})=>{const[u,d]=s.useState(0);s.useEffect(()=>{const v=setInterval(()=>{d(Date.now()-a)},1e3);return()=>clearInterval(v)},[a]);const f=Math.floor(u/1e3),c=Math.floor(f/60),g=f%60;let p="text-green-500";return c>=45&&(p="text-yellow-500"),c>=55&&(p="text-red-500"),o.jsxs("div",{className:`font-mono text-lg font-bold ${p}`,children:[String(c).padStart(2,"0"),":",String(g).padStart(2,"0")]})},X=()=>{const{sessionId:a}=D(),{token:u}=I(),[d,f]=s.useState(null),[c,g]=s.useState(null),[p,v]=s.useState(!1),[O,b]=s.useState(""),S=s.useRef(null),x=s.useRef(null),C=s.useRef(null),m=s.useRef({}),[l,y]=s.useState(null),[h,j]=s.useState(null),[R,E]=s.useState(!1),[N,T]=s.useState(!1),[L,i]=s.useState("Initializing...");s.useEffect(()=>{!a||!u||(i("Authenticating..."),P.post(`/sessions/${a}/call-token`,{},{headers:{Authorization:`Bearer ${u}`}}).then(e=>{console.log("LOG 1: Successfully received unique video token."),f(e.data.videoToken),i("Ready to start camera.")}).catch(e=>{console.error("ERROR: Failed to get video token.",e),i("Error: Authentication failed.")}))},[a,u]);const $=()=>{i("Accessing camera..."),navigator.mediaDevices.getUserMedia({video:!0,audio:!0}).then(e=>{console.log("LOG 2: Camera access granted."),y(e),x.current&&(x.current.srcObject=e),i("Camera is on. Connecting...")}).catch(e=>{console.error("ERROR: Could not access media devices.",e),i("Error: Camera not found or permission denied.")})};s.useEffect(()=>{C.current&&h&&(console.log("LOG 11: Attaching remote stream to video element."),C.current.srcObject=h,c||g(Date.now()))},[h,c]);const A=s.useCallback(e=>{b(e),S.current&&S.current.emit("notepad-change",{roomId:a,content:e})},[a]);s.useEffect(()=>{if(!d||!l)return;console.log("LOG 3: All conditions met. Initializing socket connection.");const e=z("http://localhost:5000/api",{auth:{token:d}});S.current=e,e.emit("get-notepad-content",a),e.on("notepad-content",t=>{b(t)});const w=t=>{console.log(`LOG 4: Creating peer connection for target ${t}`);const n=new RTCPeerConnection({iceServers:[{urls:"stun:stun.l.google.com:19302"}]});return n.onicecandidate=r=>{r.candidate&&(console.log(`LOG --: Sending ICE candidate to ${t}`),e.emit("ice-candidate",{target:t,candidate:r.candidate}))},n.ontrack=r=>{console.log(`LOG 10: ✅✅✅ Remote track received from ${t}!`),i("Connected!"),j(r.streams[0])},n.onconnectionstatechange=()=>{console.log(`EVENT: Connection state with ${t} is now ${n.connectionState}`),n.connectionState==="connected"&&i("Connected!"),n.connectionState==="failed"&&i("Connection failed. Please check your network and refresh.")},l.getTracks().forEach(r=>n.addTrack(r,l)),n};return e.on("connect",()=>{console.log(`LOG 5: Socket connected with ID ${e.id}. Joining room ${a}.`),e.emit("join-room",a)}),e.on("other-user",t=>{console.log(`LOG 6: 'other-user' event received. Peer ID: ${t}. Creating offer...`);const n=w(t);m.current[t]=n,n.createOffer().then(r=>n.setLocalDescription(r)).then(()=>{console.log("LOG 7: Offer created and set. Sending to peer."),e.emit("offer",{target:t,offer:n.localDescription})})}),e.on("offer",async({from:t,offer:n})=>{console.log(`LOG 6: Offer received from ${t}. Creating answer...`);const r=w(t);m.current[t]=r,await r.setRemoteDescription(new RTCSessionDescription(n));const k=await r.createAnswer();await r.setLocalDescription(k),console.log("LOG 7: Answer created and set. Sending back to peer."),e.emit("answer",{target:t,answer:k})}),e.on("answer",({from:t,answer:n})=>{console.log(`LOG 8: Answer received from ${t}. Setting remote description.`),m.current[t]?.setRemoteDescription(new RTCSessionDescription(n))}),e.on("ice-candidate",({from:t,candidate:n})=>{console.log(`LOG --: Received ICE candidate from ${t}. Adding to peer connection.`),m.current[t]?.addIceCandidate(new RTCIceCandidate(n))}),e.on("user-left",t=>{m.current[t]?.close(),delete m.current[t],j(null),i("The other user has left the call.")}),()=>{e.disconnect(),e.off("notepad-content"),Object.values(m.current).forEach(t=>t.close()),l.getTracks().forEach(t=>t.stop())}},[a,d,l]);const G=()=>{l?.getAudioTracks().forEach(e=>e.enabled=!e.enabled),E(e=>!e)},V=()=>{l?.getVideoTracks().forEach(e=>e.enabled=!e.enabled),T(e=>!e)};return o.jsxs("div",{className:"video-call-container",children:[o.jsxs("div",{className:"flex justify-between items-center",children:[o.jsx("h1",{className:"video-call-header",children:"Video Session"}),c&&o.jsx(H,{startTime:c})]}),o.jsx("p",{className:"video-call-status",children:L}),o.jsxs("div",{className:"video-grid",style:{position:"relative",overflow:"hidden"},children:[o.jsxs("div",{className:"video-participant-container",children:[o.jsx("h2",{className:"video-participant-label",children:"Your Video"}),o.jsx("video",{ref:x,autoPlay:!0,muted:!0,playsInline:!0,className:"video-element"}),!l&&d&&o.jsx("div",{className:"start-camera-overlay",children:o.jsx("button",{onClick:$,className:"start-camera-button",children:"Start Camera"})})]}),o.jsxs("div",{className:"video-participant-container",children:[o.jsx("h2",{className:"video-participant-label",children:h?"Participant's Video":"Waiting for participant..."}),o.jsx("video",{ref:C,autoPlay:!0,playsInline:!0,className:"video-element"})]}),o.jsx(B,{isOpen:p,content:O,onContentChange:A})]}),l&&o.jsxs("div",{className:"control-bar",children:[o.jsx("button",{onClick:G,className:`control-button ${R?"inactive":"active"}`,children:R?"Unmute":"Mute"}),o.jsx("button",{onClick:V,className:`control-button ${N?"inactive":"active"}`,children:N?"Start Video":"Stop Video"}),o.jsx("button",{onClick:()=>v(e=>!e),className:"control-button active",children:p?"Hide Notes":"Show Notes"})]})]})};export{X as default};
